---
# Mnemonic Plugin Behavioral Test Specifications
# Format: YAML test definitions
#
# NOTE: This file contains BEHAVIORAL SPECIFICATIONS, not automated tests.
# These define expected behavior for manual validation or future automation.
#
# For automated tests, run:
#   ./.claude/tests/run_all.sh          # All automated tests
#   ./.claude/tests/run_all.sh quick    # Quick validation only
#   ./.claude/tests/run_all.sh unit     # Unit tests only
#
# These behavioral specs are used by:
#   - Manual QA validation
#   - AI-assisted testing (human reviews Claude's behavior)
#   - Future automated test generation

version: "1.1"
description: "Mnemonic Behavioral Test Specifications"
automated_tests: ".claude/tests/run_all.sh"

tests:
  # ========================================================================
  # Natural Capture Tests - Does Claude capture without being told?
  # ========================================================================

  - id: natural_capture_decision
    description: Verify automatic capture when user makes a decision
    category: natural
    action: |
      Say: "I've decided we should use Redis for caching in this project"

      Then check if a new memory was created in decisions/ namespace.
      Run: ls -t ~/.claude/mnemonic/*/decisions/user/*.memory.md | head -1

      The most recent file should have been created within the last
      minute and contain "Redis" or "caching".
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, capture, critical, decisions]

  - id: natural_capture_learning
    description: Verify automatic capture when user shares a learning
    category: natural
    action: |
      Say: "I learned that the API rate limit is 100 requests per minute"

      Then check if a new memory was created in learnings/ namespace.
      Run: ls -t ~/.claude/mnemonic/*/learnings/user/*.memory.md | head -1

      Verify the file contains "rate limit" or "100 requests".
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, capture, critical, learnings]

  - id: natural_capture_pattern
    description: Verify automatic capture when user establishes a pattern
    category: natural
    action: |
      Say: "We should always use snake_case for database column names"

      Then check if a new memory was created in patterns/ namespace.
      Run: ls -t ~/.claude/mnemonic/*/patterns/user/*.memory.md | head -1

      Verify the file contains "snake_case" or "database".
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, capture, critical, patterns]

  - id: natural_capture_blocker
    description: Verify automatic capture when user reports being stuck
    category: natural
    action: |
      Say: "I'm stuck on the authentication flow - can't figure out
      why tokens expire early"

      Then check if a new memory was created in blockers/ namespace.
      Run: ls -t ~/.claude/mnemonic/*/blockers/user/*.memory.md | head -1

      Verify the file contains "authentication" or "tokens".
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, capture, critical, blockers]

  - id: natural_capture_context
    description: Verify capture when user asks to remember something
    category: natural
    action: |
      Say: "Remember this - the staging server password is in 1Password"

      Then check if a new memory was created in context/ namespace.
      Run: ls -t ~/.claude/mnemonic/*/context/user/*.memory.md | head -1
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, capture, critical, context]

  # ========================================================================
  # Natural Recall Tests - Does Claude search before acting?
  # ========================================================================

  - id: natural_recall_before_action
    description: Verify Claude searches memories before implementing
    category: natural
    setup: |
      First create a memory about a specific technical decision:
      Create a memory in decisions/ with title "Use JWT for auth"
      and content explaining the decision.
    action: |
      Ask: "How should we implement authentication in this project?"

      Claude should search mnemonic and reference the existing JWT
      decision rather than proposing alternatives without checking.
    expect:
      - contains: "JWT"
      - regex: "(memory|recall|found|existing|decided)"
    tags: [natural, recall, critical]

  - id: natural_recall_uses_context
    description: Verify Claude uses recalled memory in response
    category: natural
    setup: |
      Create memory: "Database is PostgreSQL 15 on AWS RDS"
    action: |
      Ask: "What database should I connect to for the new feature?"

      Response should reference PostgreSQL, not suggest alternatives.
    expect:
      - contains: "PostgreSQL"
      - not_contains: "MySQL"
      - not_contains: "MongoDB"
    tags: [natural, recall, critical]

  # ========================================================================
  # Behavior Quality Tests - Is the behavior correct?
  # ========================================================================

  - id: natural_no_duplicate_capture
    description: Verify Claude doesn't create duplicate memories
    category: natural
    action: |
      Say: "Let's use PostgreSQL for our database"
      Wait for response.
      Say: "Yes, PostgreSQL is the right choice for our database"

      Check that only ONE new memory was created about PostgreSQL.
      Run: rg -l "PostgreSQL" ~/.claude/mnemonic/*/decisions/user/ | wc -l
    expect:
      - regex: "^1$"
    tags: [natural, capture, dedup]

  - id: natural_capture_silent
    description: Verify Claude captures silently without announcing
    category: natural
    action: |
      Say: "Going forward we'll use TypeScript instead of JavaScript"

      Claude should create a memory but NOT say things like:
      - "I'm capturing this to memory"
      - "Let me save this decision"
      - "I'll remember this"
    expect:
      - not_contains: "capturing"
      - not_contains: "saving to memory"
      - not_contains: "I'll remember"
      - not_contains: "mnemonic"
    tags: [natural, capture, silent]

  - id: natural_memory_content_quality
    description: Verify captured memories have meaningful content
    category: natural
    action: |
      Say: "The fix was adding a null check before accessing user.email"

      Then read the most recent memory in learnings/:
      Run: ls -t ~/.claude/mnemonic/*/learnings/user/*.memory.md |
        head -1 | xargs cat

      The memory should contain:
      - Context about what was fixed
      - The actual solution (null check)
      - Proper metadata (title, type, id)
    expect:
      - contains: "null check"
      - contains: "title:"
      - contains: "type:"
      - regex: "id: [a-f0-9-]{36}"
    tags: [natural, capture, quality]

  # ========================================================================
  # Workflow Tests - Full cycles
  # ========================================================================

  - id: natural_workflow_full_cycle
    description: Full cycle - recall, respond, capture
    category: natural
    setup: |
      Create a test memory: "Project uses Express.js for backend API"
    action: |
      Ask: "What framework should I use for the new API endpoint?"

      Claude should:
      1. Search and find the Express.js memory
      2. Reference it in the response
      3. If user decides something new, capture it

      Verify the response mentions Express.js.
    expect:
      - contains: "Express"
    tags: [natural, workflow, e2e]

  - id: natural_workflow_capture_after_resolution
    description: Capture learning after resolving a blocker
    category: natural
    action: |
      Say: "I was stuck on the CORS error but the fix was adding
      the allowed origins to the config"

      Should capture to learnings/ with the resolution.
      Run: ls -t ~/.claude/mnemonic/*/learnings/user/*.memory.md | head -1
    expect:
      - contains: ".memory.md"
      - not_contains: "No such file"
    tags: [natural, workflow, resolution]
